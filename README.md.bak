# tfmodule-google-vpn

Terraform module for creating Classic VPN gateways on Google Cloud Platform with policy-based routing. This module provisions VPN gateways, tunnels, forwarding rules, and static routes for site-to-site connectivity.

## Features

- **Classic VPN Gateway**: Creates regional VPN gateway with static external IP
- **Multiple Tunnels**: Support for multiple VPN tunnels per gateway
- **Static Routing**: Automatic route creation for remote subnets
- **Flexible Traffic Selectors**: Configurable local and remote traffic selectors
- **Auto-generated Secrets**: Random IPsec shared secret generation
- **Custom IKE Version**: Support for IKEv1 and IKEv2
- **Forwarding Rules**: Automatic ESP, UDP 500, and UDP 4500 forwarding rules
- **Route Tagging**: Apply instance tags to VPN routes for granular control

## Usage

### Basic VPN with Single Tunnel

```hcl
module "vpn" {
  source = "github.com/xlsmartenterprise/tfmodule-google-vpn"

  project_id    = "my-project-id"
  network       = "my-vpc-network"
  region        = "us-central1"
  gateway_name  = "vpn-to-onprem"

  peer_ips      = ["203.0.113.1"]
  remote_subnet = ["10.10.0.0/16"]
}
```

### Multiple Tunnels with Custom Configuration

```hcl
module "vpn" {
  source = "github.com/xlsmartenterprise/tfmodule-google-vpn"

  project_id    = "my-project-id"
  network       = "my-vpc-network"
  region        = "us-central1"
  gateway_name  = "vpn-to-branch-offices"

  tunnel_count        = 3
  tunnel_name_prefix  = "branch-office-tunnel"

  peer_ips      = ["203.0.113.1", "203.0.113.2", "203.0.113.3"]
  remote_subnet = ["10.10.0.0/16", "10.20.0.0/16"]

  route_priority = 100
  ike_version    = 2
}
```

### VPN with Traffic Selectors

```hcl
module "vpn" {
  source = "github.com/xlsmartenterprise/tfmodule-google-vpn"

  project_id    = "my-project-id"
  network       = "my-vpc-network"
  region        = "us-west1"
  gateway_name  = "vpn-restricted"

  peer_ips      = ["203.0.113.1"]
  remote_subnet = ["192.168.0.0/16"]

  # Restrict local traffic to specific subnets
  local_traffic_selector = [
    "10.0.1.0/24",
    "10.0.2.0/24"
  ]

  # Restrict remote traffic to specific subnets
  remote_traffic_selector = [
    "192.168.1.0/24",
    "192.168.2.0/24"
  ]
}
```

### VPN with Existing External IP

```hcl
module "vpn" {
  source = "github.com/xlsmartenterprise/tfmodule-google-vpn"

  project_id    = "my-project-id"
  network       = "my-vpc-network"
  region        = "europe-west1"
  gateway_name  = "vpn-with-existing-ip"

  # Use pre-allocated external IP
  vpn_gw_ip = "34.107.xxx.xxx"

  peer_ips      = ["203.0.113.1"]
  remote_subnet = ["172.16.0.0/12"]
}
```

### VPN with Custom Shared Secret and Route Tags

```hcl
module "vpn" {
  source = "github.com/xlsmartenterprise/tfmodule-google-vpn"

  project_id    = "my-project-id"
  network       = "my-vpc-network"
  region        = "asia-southeast1"
  gateway_name  = "vpn-tagged-routes"

  peer_ips      = ["203.0.113.1"]
  remote_subnet = ["10.50.0.0/16"]

  # Custom pre-shared key
  shared_secret = "your-secure-pre-shared-key"

  # Apply routes only to specific instance tags
  route_tags = ["vpn-access", "backend-servers"]

  route_priority = 500
}
```

### Multi-Region VPN Setup

```hcl
# Primary region VPN
module "vpn_us_central" {
  source = "github.com/xlsmartenterprise/tfmodule-google-vpn"

  project_id    = "my-project-id"
  network       = "my-vpc-network"
  region        = "us-central1"
  gateway_name  = "vpn-us-central"

  peer_ips      = ["203.0.113.1"]
  remote_subnet = ["10.100.0.0/16"]
}

# Secondary region VPN
module "vpn_us_east" {
  source = "github.com/xlsmartenterprise/tfmodule-google-vpn"

  project_id    = "my-project-id"
  network       = "my-vpc-network"
  region        = "us-east1"
  gateway_name  = "vpn-us-east"

  peer_ips      = ["203.0.113.2"]
  remote_subnet = ["10.100.0.0/16"]
}
```

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| project_id | The ID of the project where this VPC will be created | `string` | n/a | yes |
| network | The name of VPC being created | `string` | n/a | yes |
| region | The region in which you want to create the VPN gateway | `string` | n/a | yes |
| peer_ips | IP address of remote-peer/gateway | `list(string)` | n/a | yes |
| remote_subnet | Remote subnet IP range in CIDR format - x.x.x.x/x | `list(string)` | n/a | yes |
| gateway_name | The name of VPN gateway | `string` | `"test-vpn"` | no |
| tunnel_count | The number of tunnels from each VPN gateway | `number` | `1` | no |
| tunnel_name_prefix | The optional custom name of VPN tunnel being created | `string` | `""` | no |
| local_traffic_selector | Local traffic selector to use when establishing the VPN tunnel with peer VPN gateway. Value should be list of CIDR formatted strings and ranges should be disjoint | `list(string)` | `["0.0.0.0/0"]` | no |
| remote_traffic_selector | Remote traffic selector to use when establishing the VPN tunnel with peer VPN gateway. Value should be list of CIDR formatted strings and ranges should be disjoint | `list(string)` | `["0.0.0.0/0"]` | no |
| shared_secret | The shared secret/pre-shared key. If not provided, a random secret will be generated | `string` | `""` | no |
| route_priority | Priority for static route being created | `number` | `1000` | no |
| ike_version | IKE version used by this tunnel (1 or 2) | `number` | `2` | no |
| vpn_gw_ip | Public IP address of the VPN Gateway. If not provided, a new static IP will be created | `string` | `""` | no |
| route_tags | A list of instance tags to which this route applies | `list(string)` | `[]` | no |
| ipsec_secret_length | The length of shared secret for VPN tunnels | `number` | `8` | no |

## Outputs

| Name | Description |
|------|-------------|
| project_id | The Project-ID |
| name | The name of the Gateway |
| gateway_self_link | The self-link of the Gateway |
| network | The name of the VPC |
| gateway_ip | The VPN Gateway Public IP |
| vpn_tunnels_names | The VPN tunnel names |
| vpn_tunnels_self_link | The VPN tunnel self-links |
| ipsec_secret | The shared secret (sensitive) |

## Requirements

| Name | Version |
|------|---------|
| terraform | >= 1.5.0 |
| google | >= 7.0.0, < 8.0.0 |
| google-beta | >= 7.0.0, < 8.0.0 |

## Implementation Notes

- **External IP**: If `vpn_gw_ip` is not provided, a new static external IP address will be automatically created
- **Shared Secret**: If `shared_secret` is not provided, a random IPsec secret will be generated with the specified length
- **Tunnel Naming**: If `tunnel_name_prefix` is empty, tunnels will be named as `{network}-{gateway_name}-tunnel-{number}`
- **Static Routes**: The module creates static routes for each combination of tunnel and remote subnet
- **Forwarding Rules**: Three forwarding rules are automatically created for ESP, UDP 500, and UDP 4500 protocols
- **Route Priority**: Lower values have higher priority (default is 1000)
- **Traffic Selectors**: Use traffic selectors to restrict which subnets can communicate through the VPN tunnel

## Changelog

See [CHANGELOG.md](./CHANGELOG.md) for version history and changes.